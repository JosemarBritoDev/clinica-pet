{% extends 'base.html' %}
{% load meus_filtros %}
{# Extende o layout base e carrega filtros personalizados para formatação, como CPF #}

{% block title %}
listagem de Cliente
{% endblock title %}

{% block page_content %}
<div class="content-wrapper" style="min-height: 1136.28px; width: 100%; margin-left: 0; margin-top: 0; padding-left: 10px; padding-top: 10px;">
  <!-- Wrapper geral do conteúdo -->

  <!-- Main content -->
  <section class="content">
    <div class="row">

      <!-- Perfil do cliente -->
      <div class="col-xs-12 col-sm-4 col-md-3">
        <div class="box box-primary">
          <div class="box-body box-profile">
            <h3 class="profile-username text-center">{{ cliente.nome }}</h3>
            <p class="text-muted text-center">{{ cliente.telefone }}</p>

            <ul class="list-group list-group-unbordered">
              <li class="list-group-item">
                <b>Endereço</b> <a class="pull-right">{{ cliente.endereco.rua }}, {{ cliente.endereco.numero }}</a>
              </li>
              <li class="list-group-item">
                <b>CPF</b> <a class="pull-right">{{ cliente.cpf|format_cpf }}</a>
              </li>
              <li class="list-group-item">
                <b>Nascimento</b> <a class="pull-right">{{ cliente.data_nascimento|date:"d/m/Y" }}</a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Pets do cliente -->
        <div class="box box-primary">
          <div class="box-header with-border">
            <h3 class="box-title">Pets</h3>
          </div>
          <div class="box-body">
            {% for pet in pets %}
              <a href="{% url 'base:listar_pet_id' pet.id %}">
                <strong><i class="fa fa-paw margin-r-5"></i> {{ pet.nome }}</strong>
              </a>
              <p class="text-muted">
                {{ pet.get_categoria_display }} - {{ pet.get_cor_display }}
              </p>
              <hr>
            {% endfor %}

            <div class="row">
              <div class="col-md-12">
                <a href="{% url 'base:cadastrar_pet' cliente.id %}" class="btn btn-primary btn-block">Cadastrar Pet</a>
                <br>
                <button type="button" class="btn btn-primary btn-block" onclick="window.history.back();">Voltar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Histórico de Consultas -->
      <div class="col-md-9">
        <div class="nav-tabs-custom">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#timeline" data-toggle="tab">Histórico</a></li>
          </ul>
          <div class="tab-content">
            <div class="active tab-pane" id="timeline">
              <ul class="timeline timeline-inverse">

                {# Data atual no topo da timeline #}
                <li class="time-label">
                  <span class="bg-green" id="dataAtual">Carregando...</span>
                </li>

                {# Loop das consultas em ordem decrescente (mais recente primeiro) #}
                {% for consulta in consultas %}
                <li>
                  <i class="fa fa-paw bg-blue"></i>
                  <div class="timeline-item">
                    <span class="time">
                      <i class="fa fa-calendar"></i> {{ consulta.data|date:"d/m/Y" }}
                    </span>
                    <h3 class="timeline-header">
                      {{ consulta.pet.nome }} realizou nova consulta
                    </h3>
                    <div class="timeline-body">
                      Esta consulta foi: {{ consulta.motivo_consulta }}
                    </div>
                    <div class="timeline-footer">
                      <a class="btn btn-primary btn-xs" href="{% url 'base:listar_consulta_id' consulta.id %}">
                        Visualizar Consulta
                      </a>
                    </div>
                  </div>
                </li>
                {% endfor %}

                {# Data da primeira consulta no final da timeline #}
                {% if consultas %}
                  {% with primeira=consultas|slice:"-1:" %}
                    <li class="time-label">
                      <span class="bg-red">
                        {{ primeira.0.data|date:"d/m/Y" }}
                      </span>
                    </li>
                  {% endwith %}
                {% endif %}

                <li><i class="fa fa-clock-o bg-gray"></i></li>

              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<!-- Script para exibir a data atual no formato "dd/mm/yyyy" -->
<script>
  function formatarDataNumerica(data) {
    const dia = String(data.getDate()).padStart(2, '0');
    const mes = String(data.getMonth() + 1).padStart(2, '0');
    const ano = data.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  function atualizarData() {
    const hoje = new Date();
    const formatado = formatarDataNumerica(hoje);
    document.getElementById('dataAtual').textContent = formatado;
  }

  atualizarData(); // chama ao carregar
</script>
{% endblock page_content %}